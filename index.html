<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAWAK3ATY</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #0f172a; color: #f8fafc; padding-bottom: 120px; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .card { background: #1e293b; border-radius: 16px; padding: 20px; margin: 10px 0; border: 1px solid #334155; }
        .balance-box { text-align: center; background: linear-gradient(45deg, #1e40af, #3b82f6); padding: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .balance-val { font-size: 2.5em; font-weight: 800; }
        .match-card { background: #334155; padding: 15px; border-radius: 12px; margin: 10px 0; border-right: 5px solid #3b82f6; position: relative; }
        .match-locked { opacity: 0.6; pointer-events: none; border-right-color: #ef4444; }
        .lock-badge { position: absolute; top: 5px; left: 5px; background: #ef4444; font-size: 10px; padding: 2px 8px; border-radius: 5px; }
        .odds-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 10px; }
        .odds-btn { padding: 12px; border: none; border-radius: 8px; background: #475569; color: #fff; cursor: pointer; font-weight: bold; }
        .bet-slip { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; border-top: 4px solid #3b82f6; padding: 20px; display: none; z-index: 1000; border-radius: 20px 20px 0 0; }
        input, button { width: 100%; padding: 12px; margin: 5px 0; border-radius: 8px; border: none; font-weight: bold; }
        button { background: #3b82f6; color: white; cursor: pointer; }
        .request-item { background: #0f172a; padding: 10px; border-radius: 10px; margin: 5px 0; border: 1px solid #475569; font-size: 12px; }
        .analysis-card { background: #070b14; border: 1px solid #fbbf24; padding: 12px; border-radius: 10px; margin: 10px 0; font-size: 13px; line-height: 1.6; }
        .btn-green { background: #22c55e !important; }
        .btn-red { background: #ef4444 !important; }
        .btn-orange { background: #f59e0b !important; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; z-index: 2000; padding: 20px; overflow-y: auto; }
        
        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        #autoPopup {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 15px; border-radius: 12px;
            width: 90%; max-width: 400px; text-align: center; z-index: 3000;
            display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-size: 13px;
            border: 2px solid #fff;
        }
        #autoPopup a { color: #fbbf24; font-weight: bold; text-decoration: underline; }
    </style>
</head>
<body>

<div id="autoPopup">
    âš ï¸ Ù…Ù† Ø§Ù„Ù…Ù…ÙƒÙ† ØªØ¹Ø·Ù„ Ø²Ø±Ø§Ø± Ø§Ù„Ø¯Ø¹Ù… ÙÙŠ Ø£ÙŠ ÙˆÙ‚ØªØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø·: <br>
    <a href="https://t.me/TAWK3ATY_BOT" target="_blank">https://t.me/TAWK3ATY_BOT</a>
</div>

<div class="container">
    <div style="text-align:center; opacity:0.3; font-size:10px; padding:10px; cursor:pointer;" onclick="checkAdmin()">WELLCOM</div>

    <div id="authPanel" class="card">
        <h2 style="text-align:center; margin-bottom:15px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <input type="text" id="userIn" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
        <input type="password" id="passIn" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
        <button onclick="handleReg()" style="background:#475569;">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <div id="userPanel" style="display:none;">
        <div class="balance-box">
            <div style="font-size: 0.9em;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…ØªÙˆÙØ±</div>
            <div class="balance-val" id="balDisplay">0</div>
            <div style="display:flex; gap:5px; margin-top:10px;">
                <button onclick="requestTopup()" style="background:rgba(255,255,255,0.2); font-size:12px;">Ø´Ø­Ù† âš¡</button>
                <button onclick="requestWithdraw()" style="background:#ef4444; font-size:12px;">Ø³Ø­Ø¨ ğŸ’¸</button>
            </div>
        </div>
        <div id="activeCodeArea" style="display:none; text-align:center; margin:10px; color:#fbbf24; background:#1e293b; padding:10px; border-radius:10px; border: 1px dashed #fbbf24;">
            Ø³ÙŠØªÙ… Ø´Ø­Ù† <b id="userSentAmt">0</b>Ø¬ | ÙƒÙˆØ¯ Ø§Ù„Ø´Ø­Ù†: <b id="userSentCode" style="font-size:20px;"></b>
        </div>
        <div id="notifications" style="margin-top:15px;"></div>
        <div style="display: flex; gap: 5px; margin-top: 10px;">
            <button onclick="showMyBets()" style="background:#475569;">Ø±Ù‡Ø§Ù†Ø§ØªÙŠ</button>
            <button onclick="window.location.href='https://t.me/TAWK3ATY_BOT" style="background:#22c55e;">Ø§Ù„Ø¯Ø¹Ù…</button>
            <button onclick="location.reload()" style="background:#94a3b8;">Ø®Ø±ÙˆØ¬</button>
        </div>
        <h3 style="margin-top:20px; color:#3b82f6;">Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ğŸ”¥</h3>
        <div id="matchList"></div>
    </div>

    <div id="adminPanel" style="display:none;" class="card">
        <h3 style="color:#fbbf24; text-align:center;">ğŸ“Š Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³ÙŠÙˆÙ„Ø© ÙˆØ§Ù„Ø±Ù‡Ø§Ù†Ø§Øª</h3>
        <div id="liveRiskAnalysis"></div>
        <div class="card" style="background:#0f172a;">
            <h4 style="color:#3b82f6;">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
            <input id="targetUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                <button onclick="adminEditUser('balance')" class="btn-green">ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯</button>
                <button onclick="adminEditUser('password')" class="btn-orange">ØªØºÙŠÙŠØ± Ø¨Ø§Ø³ÙˆØ±Ø¯</button>
            </div>
            <button onclick="adminDeleteUser()" class="btn-red" style="margin-top: 5px;">âŒ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        </div>
        <div class="card" style="background:#0f172a;">
            <h4>ğŸ“¥ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4>
            <div id="adminRequests"></div>
        </div>
        <div class="card" style="background:#0f172a;">
            <h4>Ù†Ø´Ø± Ù…Ø¨Ø§Ø±Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
            <input id="newMName" placeholder="Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©">
            <div class="odds-grid">
                <input id="newO1" type="number" step="0.01" placeholder="Ù†Ø³Ø¨Ø© 1">
                <input id="newOX" type="number" step="0.01" placeholder="Ù†Ø³Ø¨Ø© X">
                <input id="newO2" type="number" step="0.01" placeholder="Ù†Ø³Ø¨Ø© 2">
            </div>
            <button onclick="addNewMatch()" class="btn-green">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
        </div>
        <h4 style="margin-top:10px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬:</h4>
        <div id="adminMatchList"></div>
    </div>
</div>

<div id="betsModal" class="modal">
    <h2 style="text-align:center; color:#3b82f6;">Ø±Ù‡Ø§Ù†Ø§ØªÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ©</h2>
    <div id="betsContainer"></div>
    <button onclick="document.getElementById('betsModal').style.display='none'" style="background:#ef4444; margin-top:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<div id="slip" class="bet-slip">
    <h3 style="color:#3b82f6;">ğŸ“ Ù‚Ø³ÙŠÙ…Ø© Ø±Ù‡Ø§Ù†</h3>
    <div id="slipDetails" style="font-size:11px; color:#94a3b8; margin:10px 0;"></div>
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <span>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒÙ„ÙŠØ©:</span> <strong id="slipTotalOdds" style="color:#22c55e;">0.00</strong>
    </div>
    <input type="number" id="betAmt" placeholder="Ø­Ø¯Ø¯ Ø§Ù„Ù…Ø¨Ù„Øº">
    <button onclick="placeBet()" class="btn-green">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù‡Ø§Ù† âœ…</button>
    <button onclick="cancelSlip()" style="background:#475569;">Ø¥Ù„ØºØ§Ø¡</button>
</div>

<script>
    // ØªÙƒÙˆÙŠÙ† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„ØµØ­ÙŠØ­Ø©)
    const firebaseConfig = {
        apiKey: "AIzaSyDrwa6NIU7VVVItmGBrVD9IPwyBJqU1gjI",
        authDomain: "tawak3aty.firebaseapp.com",
        projectId: "tawak3aty",
        storageBucket: "tawak3aty.firebasestorage.app",
        messagingSenderId: "950032348160",
        appId: "1:950032348160:web:5c50ded76032e877c1d4e5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let user = null; let currentSlip = []; let adminClicks = 0;

    // --- ÙƒÙˆØ¯ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ ---
    setInterval(() => {
        const pop = document.getElementById('autoPopup');
        pop.style.display = 'block';
        // ÙŠØ®ØªÙÙŠ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†ÙŠ Ù„ÙŠØ¸Ù‡Ø± Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ Ø§Ù„ÙƒÙ„ÙŠØ©
        setTimeout(() => { pop.style.display = 'none'; }, 3000);
    }, 5000);

    // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ (Login, Reg, Admin, Matches...)
    function checkAdmin() { if(++adminClicks >= 5) { if(prompt("Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯:") === "TAWAK3ATY2025") { document.getElementById('adminPanel').style.display = 'block'; loadAdminData(); } } }

    async function handleLogin() {
        const u = document.getElementById('userIn').value.trim();
        const p = document.getElementById('passIn').value.trim();
        const d = await db.collection('users').doc(u).get();
        if(d.exists && d.data().passwordHash === btoa(u+p)) {
            user = d.data();
            document.getElementById('authPanel').style.display='none';
            document.getElementById('userPanel').style.display='block';
            updateUI(); loadMatches(); loadNotifications();
        } else alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    }

    async function handleReg() {
        const u = document.getElementById('userIn').value.trim();
        const p = document.getElementById('passIn').value.trim();
        if(!u || !p) return alert("Ø§Ù…Ù„Ø§Ù‹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        const doc = await db.collection('users').doc(u).get();
        if(doc.exists) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø­Ø¬ÙˆØ²");
        await db.collection('users').doc(u).set({ username: u, passwordHash: btoa(u+p), balance: 0, bets: [], notifications: ["Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!"] });
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ!");
    }

    function updateUI() { document.getElementById('balDisplay').textContent = user.balance.toFixed(2); }

    async function loadAdminData() {
        try {
            const mSnap = await db.collection('matches').where('active','==',true).get();
            const usersSnap = await db.collection('users').get();
            let report = {}; let mh = '';
            mSnap.forEach(doc => {
                const m = doc.data();
                report[doc.id] = { name: m.name, team1: 0, draw: 0, team2: 0 };
                mh += `<div class="request-item">
                    <b>${m.name}</b>
                    <div style="display:flex; gap:3px; margin-top:5px;">
                        <button onclick="toggleLock('${doc.id}', ${m.isLocked || false})" class="btn-orange" style="font-size:10px;">${m.isLocked ? 'ğŸ”“ ÙØªØ­' : 'ğŸ”’ Ù‚ÙÙ„'}</button>
                        <button onclick="settleMatch('${doc.id}','team1')" style="font-size:10px;">1</button>
                        <button onclick="settleMatch('${doc.id}','draw')" style="font-size:10px;">X</button>
                        <button onclick="settleMatch('${doc.id}','team2')" style="font-size:10px;">2</button>
                    </div>
                </div>`;
            });
            usersSnap.forEach(uDoc => {
                const u = uDoc.data();
                if (u.bets && Array.isArray(u.bets)) {
                    u.bets.forEach(b => {
                        if (b.status === 'pending' && b.matches) {
                            b.matches.forEach(m => {
                                if (report[m.mId]) report[m.mId][m.type] += (b.amt || 0);
                            });
                        }
                    });
                }
            });
            let ah = '';
            for (let id in report) {
                ah += `<div class="analysis-card"><b>ğŸ“ ${report[id].name}</b><br>1: ${report[id].team1}Ø¬ | X: ${report[id].draw}Ø¬ | 2: ${report[id].team2}Ø¬</div>`;
            }
            document.getElementById('liveRiskAnalysis').innerHTML = ah || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§Ù‡Ù†Ø§Øª Ù†Ø´Ø·Ø©";
            document.getElementById('adminMatchList').innerHTML = mh;

            const tSnap = await db.collection('topupRequests').get();
            const wSnap = await db.collection('withdrawRequests').where('status','==','pending').get();
            let rh = '';
            tSnap.forEach(d => {
                rh += `<div class="request-item">âš¡ Ø´Ø­Ù†: ${d.id} | ${d.data().amount}Ø¬ | ÙƒÙˆØ¯: ${d.data().code}
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button onclick="approveTopup('${d.id}', ${d.data().amount})" class="btn-green">Ù‚Ø¨ÙˆÙ„</button>
                        <button onclick="rejectTopup('${d.id}')" class="btn-red">Ø±ÙØ¶</button>
                    </div></div>`;
            });
            wSnap.forEach(d => {
                rh += `<div class="request-item">ğŸ’¸ Ø³Ø­Ø¨: ${d.data().username} | ${d.data().amount}Ø¬ | ${d.data().phone}
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button onclick="approveWithdraw('${d.id}', '${d.data().username}', ${d.data().amount})" class="btn-green">Ù‚Ø¨ÙˆÙ„</button>
                        <button onclick="rejectWithdraw('${d.id}', '${d.data().username}', ${d.data().amount})" class="btn-red">Ø±ÙØ¶</button>
                    </div></div>`;
            });
            document.getElementById('adminRequests').innerHTML = rh || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©';
        } catch(e) { console.error(e); }
    }

    async function approveTopup(uId, amt) { await db.collection('users').doc(uId).update({ balance: firebase.firestore.FieldValue.increment(amt), notifications: firebase.firestore.FieldValue.arrayUnion(`âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø´Ø­Ù† ${amt}Ø¬ Ø¨Ù†Ø¬Ø§Ø­`) }); await db.collection('topupRequests').doc(uId).delete(); loadAdminData(); alert("ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„"); }
    async function rejectTopup(uId) { await db.collection('users').doc(uId).update({ notifications: firebase.firestore.FieldValue.arrayUnion(`âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ`) }); await db.collection('topupRequests').doc(uId).delete(); loadAdminData(); alert("ØªÙ… Ø§Ù„Ø±ÙØ¶"); }
    async function approveWithdraw(id, uId, amt) { await db.collection('withdrawRequests').doc(id).update({ status: 'completed' }); await db.collection('users').doc(uId).update({ notifications: firebase.firestore.FieldValue.arrayUnion(`âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø³Ø­Ø¨ ${amt}Ø¬ Ø¨Ù†Ø¬Ø§Ø­`) }); loadAdminData(); alert("ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„"); }
    async function rejectWithdraw(id, uId, amt) { await db.collection('users').doc(uId).update({ balance: firebase.firestore.FieldValue.increment(amt), notifications: firebase.firestore.FieldValue.arrayUnion(`âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø³Ø­Ø¨ ${amt}Ø¬ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±ØµÙŠØ¯`) }); await db.collection('withdrawRequests').doc(id).delete(); loadAdminData(); alert("ØªÙ… Ø§Ù„Ø±ÙØ¶"); }

    async function placeBet() {
        const amt = parseFloat(document.getElementById('betAmt').value);
        if(!amt || amt > user.balance || amt < 10) return alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¨Ù„Øº");
        const betId = Date.now().toString();
        await db.collection('users').doc(user.username).update({
            balance: firebase.firestore.FieldValue.increment(-amt),
            bets: firebase.firestore.FieldValue.arrayUnion({ id: betId, matches: currentSlip, amt, totalOdds: parseFloat(document.getElementById('slipTotalOdds').textContent), status: 'pending' })
        });
        alert("ØªÙ… Ø§Ù„Ø±Ù‡Ø§Ù†!"); location.reload();
    }

    async function settleMatch(matchId, winnerResult) {
        if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©ØŸ`)) return;
        await db.collection('results').doc(matchId).set({ winner: winnerResult });
        await db.collection('matches').doc(matchId).delete();
        alert("ØªÙ… Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©.");
        loadAdminData(); loadMatches();
    }

    function showMyBets() {
        const modal = document.getElementById('betsModal');
        const container = document.getElementById('betsContainer');
        modal.style.display = 'block';
        let h = '';
        if(!user.bets || user.bets.length === 0) h = '<p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ù‡Ø§Ù†Ø§Øª</p>';
        else {
            user.bets.slice().reverse().forEach(b => {
                let color = b.status === 'won' ? '#22c55e' : (b.status === 'lost' ? '#ef4444' : '#fbbf24');
                h += `<div class="card" style="border:1px solid ${color}">
                    <p>Ø§Ù„Ù…Ø¨Ù„Øº: ${b.amt}Ø¬ | Ø§Ù„Ù†Ø³Ø¨Ø©: ${b.totalOdds}</p>
                    <p>Ø§Ù„Ø­Ø§Ù„Ø©: <b style="color:${color}">${b.status === 'pending' ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' : (b.status === 'won' ? 'Ø±Ø§Ø¨Ø­' : 'Ø®Ø§Ø³Ø±')}</b></p>
                    ${b.status === 'pending' ? `<button onclick="claimPrize('${b.id}')" class="btn-green">Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ğŸ’°</button>` : ''}
                </div>`;
            });
        }
        container.innerHTML = h;
    }

    async function claimPrize(betId) {
        let bets = [...user.bets];
        let bet = bets.find(x => x.id === betId);
        if(!bet) return;
        let finished = true; let isWin = true;
        for(let m of bet.matches) {
            const res = await db.collection('results').doc(m.mId).get();
            if(!res.exists) { finished = false; break; }
            if(res.data().winner !== m.type) isWin = false;
        }
        if(!finished) return alert("Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø© Ù„Ù… ØªÙ†ØªÙ‡Ù Ø¨Ø¹Ø¯");
        if(isWin) {
            const prize = bet.amt * bet.totalOdds;
            bet.status = 'won';
            await db.collection('users').doc(user.username).update({ balance: firebase.firestore.FieldValue.increment(prize), bets: bets, notifications: firebase.firestore.FieldValue.arrayUnion(`ğŸ’° Ù…Ø¨Ø±ÙˆÙƒ! Ø§Ù„ØªÙ‚Ø§Ø· Ø£Ø±Ø¨Ø§Ø­ Ø¨Ù‚ÙŠÙ…Ø© ${prize.toFixed(2)}Ø¬`) });
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­!");
        } else {
            bet.status = 'lost';
            await db.collection('users').doc(user.username).update({ bets: bets });
            alert("Ø§Ù„Ø±Ù‡Ø§Ù† Ø®Ø§Ø³Ø±");
        }
        location.reload();
    }

    async function loadMatches() {
        const snap = await db.collection('matches').where('active','==',true).get();
        let h = ''; snap.forEach(doc => {
            const m = doc.data();
            h += `<div class="match-card ${m.isLocked ? 'match-locked' : ''}">
                ${m.isLocked ? '<span class="lock-badge">Ù…ØºÙ„Ù‚ ğŸ”’</span>' : ''}
                <p style="text-align:center; font-weight:bold;">${m.name}</p>
                <div class="odds-grid">
                    <button class="odds-btn" onclick="addToSlip('${doc.id}','${m.name}','team1',${m.o1})">1 (${m.o1})</button>
                    <button class="odds-btn" onclick="addToSlip('${doc.id}','${m.name}','draw',${m.ox})">X (${m.ox})</button>
                    <button class="odds-btn" onclick="addToSlip('${doc.id}','${m.name}','team2',${m.o2})">2 (${m.o2})</button>
                </div></div>`;
        });
        document.getElementById('matchList').innerHTML = h || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹';
    }

    function addToSlip(mId, name, type, odds) {
        currentSlip = [{ mId, name, type, odds }];
        document.getElementById('slip').style.display = 'block';
        document.getElementById('slipTotalOdds').textContent = odds;
        document.getElementById('slipDetails').textContent = name;
    }

    async function requestTopup() {
        const amt = parseFloat(prompt("Ø§Ù„Ù…Ø¨Ù„Øº:")); if(!amt) return;
        const c = Math.floor(1000 + Math.random() * 8999);
        await db.collection('topupRequests').doc(user.username).set({ code: c, amount: amt });
        document.getElementById('activeCodeArea').style.display = 'block';
        document.getElementById('userSentAmt').textContent = amt;
        document.getElementById('userSentCode').textContent = c;
    }

    async function requestWithdraw() {
        const amt = parseFloat(prompt("Ø§Ù„Ù…Ø¨Ù„Øº:")); if(!amt || amt > user.balance) return alert("Ø®Ø·Ø£");
        const ph = prompt("Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©:");
        await db.collection('withdrawRequests').add({ username: user.username, amount: amt, phone: ph, status: 'pending' });
        await db.collection('users').doc(user.username).update({ balance: firebase.firestore.FieldValue.increment(-amt) });
        alert("Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©"); location.reload();
    }

    async function toggleLock(id, status) { await db.collection('matches').doc(id).update({ isLocked: !status }); loadAdminData(); loadMatches(); }
    async function addNewMatch() { const n = document.getElementById('newMName').value; await db.collection('matches').add({ name: n, o1: parseFloat(document.getElementById('newO1').value), ox: parseFloat(document.getElementById('newOX').value), o2: parseFloat(document.getElementById('newO2').value), active: true, isLocked: false }); loadAdminData(); loadMatches(); }
    async function adminEditUser(t) { const u = document.getElementById('targetUser').value.trim(); const v = prompt("Ø§Ù„Ù‚ÙŠÙ…Ø©:"); if(t==='balance') await db.collection('users').doc(u).update({ balance: parseFloat(v) }); else await db.collection('users').doc(u).update({ passwordHash: btoa(u+v) }); alert("ØªÙ…"); }
    async function adminDeleteUser() { if(confirm("Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")) { await db.collection('users').doc(document.getElementById('targetUser').value.trim()).delete(); alert("ØªÙ…"); } }
    function cancelSlip() { document.getElementById('slip').style.display='none'; }
    async function loadNotifications() { let h = ''; if(user.notifications) user.notifications.slice(-3).reverse().forEach(n => h += `<div class="request-item">ğŸ”” ${n}</div>`); document.getElementById('notifications').innerHTML = h; }
    window.onload = loadMatches;
</script>
</body>
</html>
